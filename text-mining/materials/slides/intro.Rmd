---
title: "Text Mining"
subtitle: "<br><br>USING TIDY DATA PRINCIPLES"
output:
  xaringan::moon_reader:
    css: ["../../../slides.css", "css/xaringan-themer.css", "css/footer_plus.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      slideNumberFormat: "%current%"
      ratio: "16:9"
    seal: false  
    includes:
      in_header: header.html
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE,
        width = 80)
library(knitr)
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, dpi = 300)
library(tidyverse)
library(silgelib)
theme_set(theme_roboto())
```


---
class: middle

# Tidytext

---
class: middle, center

# <i class="fa fa-github"></i>

## Let's install some packages

```{r, eval=FALSE}
install.packages(c("tidyverse", 
                   "tidytext", 
                   "gutenbergr"))
```

---

<img src="figs/purple_emily.png" style="position:absolute;top:20px;right:20px;" width="100px"/>

## **What do we mean by tidy text?**


```{r}
text <- c("Tell all the truth but tell it slant —",
          "Success in Circuit lies",
          "Too bright for our infirm Delight",
          "The Truth's superb surprise",
          "As Lightning to the Children eased",
          "With explanation kind",
          "The Truth must dazzle gradually",
          "Or every man be blind —")

text
```

---

<img src="figs/purple_emily.png" style="position:absolute;top:20px;right:20px;" width="100px"/>

## **What do we mean by tidy text?**

```{r}
library(tidyverse)

text_df <- tibble(line = 1:8, text = text)

text_df
```

---

<img src="figs/purple_emily.png" style="position:absolute;top:20px;right:20px;" width="100px"/>

## **What do we mean by tidy text?**

```{r}
library(tidytext)

text_df %>%
  unnest_tokens(word, text)        #<<
```

---

<img src="figs/blue_jane.png" width="150px"/>

## Jane wants to know...

.large[A tidy text dataset typically has]

- .unscramble[more]
- .unscramble[fewer]

.large[rows than the original, non-tidy text dataset.]

---

## **Gathering more data**

.large[You can access the full text of many public domain works from [Project Gutenberg](https://www.gutenberg.org/) using the [gutenbergr](https://ropensci.org/tutorials/gutenbergr_tutorial.html) package.]


```{r}
library(gutenbergr)

full_text <- gutenberg_download(1342)
```

.large[What book do *you* want to analyze today? `r emo::ji_glue(":book: :partying: :book:")`]

---

## **Time to tidy your text!**

```{r}
tidy_book <- full_text %>%
  mutate(line = row_number()) %>%
  unnest_tokens(word, text)                #<<

glimpse(tidy_book)
```

---

## **What are the most common words?**

.large[What do you predict will happen if we run the following code? `r emo::ji("thinking")`]

```{r, eval=FALSE}
tidy_book %>%
  count(word, sort = TRUE)
```

---

## **What are the most common words?**

.large[What do you predict will happen if we run the following code? `r emo::ji("thinking")`]

```{r}
tidy_book %>%
  count(word, sort = TRUE)
```

---

background-image: url(figs/stop.gif)
background-size: 500px
background-position: 50% 50%

## **Stop words**

---

## **Stop words**

```{r}
get_stopwords()
```

---

## **Stop words**

```{r}
get_stopwords(language = "es")
```

---

## **Stop words**

```{r}
get_stopwords(language = "pt")
```

---

## **Stop words**

```{r}
get_stopwords(source = "smart")
```

---

## **What are the most common words?**

.unscramble[U N S C R A M B L E]

```
anti_join(get_stopwords(source = "smart")) %>%
```
```
tidy_book %>%
```
```
count(word, sort = TRUE) %>%
```
```
coord_flip()
```
```
geom_col() +
```
```
top_n(20) %>%
```
```
ggplot(aes(fct_reorder(word, n), n)) +  
```

---

## **What are the most common words?**

```{r, eval = FALSE}
tidy_book %>%
  anti_join(get_stopwords(source = "smart")) %>%
  count(word, sort = TRUE) %>%
  top_n(20) %>%
  ggplot(aes(fct_reorder(word, n), n)) +            #<<
  geom_col() +
  coord_flip()
```


---

```{r, echo=FALSE, fig.height=3.9}
tidy_book %>%
  anti_join(get_stopwords(source = "smart")) %>%
  count(word, sort = TRUE) %>%
  top_n(20) %>%
  ggplot(aes(fct_reorder(word, n), n)) +
  geom_col(fill = "midnightblue", alpha = 0.9) +
  coord_flip() +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = NULL, y = "Number of occurrences")
```

---

background-image: url(figs/tilecounts-1.png)
background-size: 700px

---

background-image: url(figs/tilerate-1.png)
background-size: 700px

---

background-image: url(figs/p_and_p_cover.png)
background-size: cover

class: inverse, center, middle

## SENTIMENT ANALYSIS `r emo::ji_glue(":smile: :cry: :angry:")`

---

## **Sentiment lexicons**

```{r}
get_sentiments("afinn")
```

---

## **Sentiment lexicons**

```{r}
get_sentiments("bing")
```

---

## **Sentiment lexicons**


```{r}
get_sentiments("nrc")
```

---

## **Sentiment lexicons**

```{r}
get_sentiments("loughran")
```

---

## **Implementing sentiment analysis**

```{r}
tidy_book %>%
  inner_join(get_sentiments("bing")) %>%            #<<
  count(sentiment, sort = TRUE)
```

---

<img src="figs/blue_jane.png" width="150px"/>

## Jane wants to know...

.large[What kind of join is appropriate for sentiment analysis?]

- .large[`anti_join()`]
- .large[`full_join()`]
- .large[`outer_join()`]
- .large[`inner_join()`]

---

## **Implementing sentiment analysis**

.large[What do you predict will happen if we run the following code? `r emo::ji("thinking")`]

```{r, eval=FALSE}
tidy_book %>%
  inner_join(get_sentiments("bing")) %>%            
  count(sentiment, word, sort = TRUE)             #<<
```

---

## **Implementing sentiment analysis**

.large[What do you predict will happen if we run the following code? `r emo::ji("thinking")`]

```{r }
tidy_book %>%
  inner_join(get_sentiments("bing")) %>%            
  count(sentiment, word, sort = TRUE)             #<<
```

---

## **Implementing sentiment analysis**

```{r, eval = FALSE}
tidy_book %>%
  inner_join(get_sentiments("bing")) %>%
  count(sentiment, word, sort = TRUE) %>%
  group_by(sentiment) %>%
  top_n(10) %>%
  ungroup %>%
  ggplot(aes(fct_reorder(word, n),               #<<
             n, 
             fill = sentiment)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~ sentiment, scales = "free") 
```

---

class: middle

```{r, echo=FALSE, fig.height=3.9}
tidy_book %>%
  inner_join(get_sentiments("bing")) %>%
  count(sentiment, word, sort = TRUE) %>%
  group_by(sentiment) %>%
  top_n(10) %>%
  ungroup %>%
  ggplot(aes(fct_reorder(word, n), n, fill = sentiment)) +
  geom_col(alpha = 0.9, show.legend = FALSE) +
  coord_flip() +
  facet_wrap(~ sentiment, scales = "free") +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = NULL, y = "Number of occurrences")
```

---

background-image: url(figs/p_and_p_cover.png)
background-size: cover

class: inverse, center, middle

## WHAT IS A DOCUMENT ABOUT? `r emo::ji("thinking")`

---

## **What is a document about?**

- .large[Term frequency]
- .large[Inverse document frequency]

$$idf(\text{term}) = \ln{\left(\frac{n_{\text{documents}}}{n_{\text{documents containing term}}}\right)}$$

### tf-idf is about comparing **documents** within a **collection**.

---

## **Understanding tf-idf**

.large[Make a collection (*corpus*) for yourself! `r emo::ji("nail")`]

```{r}
full_collection <- gutenberg_download(c(1342, 158, 161, 141),
                                      meta_fields = "title")

```
---

## **Understanding tf-idf**

.large[Make a collection (*corpus*) for yourself! `r emo::ji("nail")`]

```{r}
full_collection
```

---

## **Counting word frequencies in your collection**

```{r}
book_words <- full_collection %>%
  unnest_tokens(word, text) %>%                #<<
  count(title, word, sort = TRUE)
```

What do the columns of `book_words` tell us?

---

## **Calculating tf-idf**

```{r}
book_tfidf <- book_words %>%
  bind_tf_idf(word, title, n)            #<<
```

---

## **Calculating tf-idf**

.large[That's... super exciting???]

```{r}
book_tfidf
```


---

## **Calculating tf-idf**

.large[What do you predict will happen if we run the following code? `r emo::ji("thinking")`]

```{r, eval=FALSE}
book_tfidf %>%
  arrange(-tf_idf)
```

---

## **Calculating tf-idf**

.large[What do you predict will happen if we run the following code? `r emo::ji("thinking")`]

```{r}
book_tfidf %>%
  arrange(-tf_idf)
```

---

## **Calculating tf-idf**

.unscramble[U N S C R A M B L E]

```
group_by(title) %>%
```
```
book_tfidf %>%
```
```
top_n(10) %>%
```
```
ggplot(aes(fct_reorder(word, tf_idf), tf_idf, fill = title)) +
```
```
facet_wrap(~title, scales = "free")
```
```
ungroup %>%
```
```
geom_col(show.legend = FALSE) +
```
```
coord_flip() +
```
---

## **Calculating tf-idf**

```{r, eval = FALSE}
book_tfidf %>%
  group_by(title) %>%
  top_n(10) %>%
  ungroup %>%
  ggplot(aes(fct_reorder(word, tf_idf),               #<<
             tf_idf, 
             fill = title)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  facet_wrap(~title, scales = "free")
```

---

```{r, echo=FALSE, fig.height=3.9}
book_tfidf %>%
  group_by(title) %>%
  top_n(10) %>%
  ungroup %>%
  ggplot(aes(fct_reorder(word, tf_idf), 
             tf_idf, 
             fill = title)) +
  geom_col(alpha = 0.9, show.legend = FALSE) +
  coord_flip() +
  facet_wrap(~title, scales = "free") +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = NULL, y = "tf-idf")
```

---

background-image: url(figs/plot_tf_idf-1.png)
background-size: 800px

